<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سوق بئرعجم للمنتجات</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; direction: rtl; background:#f5f7fb; padding:18px; color:#0b1726; }
  .wrap { max-width:980px; margin:auto; }
  header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
  input[type="search"] { padding:8px; border-radius:8px; border:1px solid #d7dbe6; width:260px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }
  .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:700; }
  .meta { display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#6b7280; }
  .actions { display:flex; gap:8px; margin-top:8px; }
  button { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; }
  .btn-primary { background:#0f62fe; color:#fff; }
  .btn-sec { background:#eef2ff; color:#0f62fe; }
  #cartBtn { background:#06b6d4; color:#fff; border-radius:8px; padding:8px 10px; }
  #log { margin-top:12px; color:#b91c1c; }
  /* تأثيرات الصور */
  .product-image { width:80px; height:auto; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:transform 0.3s, box-shadow 0.3s; }
  .product-image:hover { transform:scale(1.02); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
  @media(max-width:768px){
    .grid { grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); }
    input[type="search"] { width: 100%; }
    header { flex-direction: column; align-items: flex-start; }
    #cartPanel { font-size:16px; }
  }
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1 style="margin:0">سوق بئرعجم للمنتجات</h1>
    <div style="color:#6b7280;font-size:13px">مرحباً بك</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div id="count" style="background:#eef2ff;padding:6px 8px;border-radius:8px">--</div>
    <input id="search" type="search" placeholder="ابحث باسم المنتج..." />
    <button id="cartBtn">السلة (0)</button>
  </div>
</header>

<main>
<section id="products" class="grid">جارٍ التحميل...</section>

<section id="cartPanel" style="display:none;margin-top:14px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1);">
  <h3>السلة</h3>
  <ul id="cartList" style="padding:0;margin:0;list-style:none"></ul>
  <div style="margin-top:10px;font-weight:700">الإجمالي: <span id="cartTotal">0</span> ل.س</div>
  <div style="margin-top:8px; display:flex; gap:8px;">
    <button id="clearCart" class="btn-sec">تفريغ السلة</button>
    <button id="startOrder" class="btn-primary">إرسال الطلب</button>
  </div>
</section>

<!-- نموذج إدخال بيانات المستخدم -->
<div style="margin-top:20px;text-align:center;">
  <button id="openUserForm" class="btn-primary">إدخال معلومات المستخدم</button>
</div>

<div id="userFormContainer" style="display:none; margin-top:20px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); max-width:400px; margin:auto;">
  <h3>معلومات المستخدم</h3>
  <form id="userForm">
    <input type="text" id="userName" placeholder="الاسم الكامل" required style="width:100%; padding:8px; margin:6px 0; border-radius:6px; border:1px solid #ccc;" />
    <input type="text" id="userAddress" placeholder="العنوان" required style="width:100%; padding:8px; margin:6px 0; border-radius:6px; border:1px solid #ccc;" />
    <input type="tel" id="userPhone" placeholder="رقم الهاتف" required style="width:100%; padding:8px; margin:6px 0; border-radius:6px; border:1px solid #ccc;" />
    <button type="submit" class="btn-primary" style="margin-top:10px;">حفظ البيانات</button>
  </form>
</div>

<div id="log"></div>
</main>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqUZQR3O5Ux3nyWsbgdnlQxcAU7qKXrKU",
  authDomain: "local-products-82f7d.firebaseapp.com",
  databaseURL: "https://local-products-82f7d-default-rtdb.firebaseio.com",
  projectId: "local-products-82f7d",
  storageBucket: "local-products-82f7d.appspot.com",
  messagingSenderId: "92892216531",
  appId: "1:92892216531:web:b39013834c0215eaf2e826"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const productsEl = document.getElementById('products');
const countEl = document.getElementById('count');
const searchEl = document.getElementById('search');
const cartBtn = document.getElementById('cartBtn');
const cartPanel = document.getElementById('cartPanel');
const cartList = document.getElementById('cartList');
const cartTotal = document.getElementById('cartTotal');

let products = [];
let filtered = [];
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let userData = {};

function loadProducts() {
  productsEl.innerHTML='جارٍ التحميل...';
  // هنا يمكنك تحميل المنتجات من Firebase أو من مصدر ثابت
  // كمثال ثابت:
  products=[
    {id:0, name:'جبنة شركسية 1', quantity:50, price:5000, imageUrl:'https://via.placeholder.com/240x180?text=جبنة+شركسية'},
    {id:1, name:'جبنة شركسية 2', quantity:30, price:6000, imageUrl:'https://via.placeholder.com/240x180?text=جبنة+شركسية'},
    {id:2, name:'منتج آخر', quantity:20, price:4000, imageUrl:'https://via.placeholder.com/240x180?text=منتج+جديد'},
    // أضف منتجات أخرى حسب الحاجة
  ];
  filtered=products.slice();
  renderProducts();
  renderCart();
}

function renderProducts() {
  productsEl.innerHTML='';
  if(products.length===0){
    productsEl.innerHTML='<div style="color:#6b7280">لا توجد منتجات</div>';
    countEl.innerText='0';
    return;
  }
  countEl.innerText=String(products.length);
  products.forEach(p => {
    const cardHTML=`
      <div class="card">
        <img src="${p.imageUrl}" class="product-image" />
        <div class="title">${p.name}</div>
        <div class="meta">
          <div>السعر: <strong>${Number(p.price).toLocaleString()}</strong> ل.س</div>
          <div>الكمية: <span>${Number(p.quantity)}</span></div>
        </div>
        <div class="actions">
          <button class="btn-sec" data-action="details" data-id="${p.id}">تفاصيل</button>
          <button class="btn-primary" data-action="add" data-id="${p.id}">أضف للسلة</button>
        </div>
      </div>`;
    const div=document.createElement('div');
    div.innerHTML=cardHTML;
    productsEl.appendChild(div);
  });
}

function showDetails(id){
  const p=products.find(x=>x.id===Number(id));
  if(!p) return alert('غير متوفر');
  alert(p.name+'\nالسعر: '+Number(p.price).toLocaleString()+' ل.س\nالكمية المتاحة: '+Number(p.quantity));
}

document.body.addEventListener('click', e => {
  const btn=e.target.closest('button');
  if(!btn) return;
  const action=btn.getAttribute('data-action');
  const id=btn.getAttribute('data-id');
  if(action==='add') addToCart(id);
  if(action==='details') showDetails(id);
});

function addToCart(id){
  id=Number(id);
  const p=products.find(x=>x.id===id);
  if(!p){ alert('المنتج غير موجود'); return; }
  if(p.quantity<=0){ alert('الكمية غير متاحة'); return; }

  const existing=cart.find(c=>c.id===id);
  if(existing){
    if(existing.qty+1>p.quantity){ alert('تجاوزت الكمية المتاحة'); return; }
    existing.qty++;
  }else{
    cart.push({id:id, name:p.name, price:p.price, qty:1});
  }
  saveCart();
  renderCart();
}

function saveCart() {
  localStorage.setItem('cart', JSON.stringify(cart));
}

function renderCart() {
  let totalCount=0;
  let totalPrice=0;
  cart.forEach(i => {
    totalCount+=i.qty;
    totalPrice+=i.price*i.qty;
  });
  document.getElementById('cartBtn').innerText='السلة ('+totalCount+')';
  document.getElementById('cartTotal').innerText=totalPrice.toLocaleString();

  const ul=document.getElementById('cartList');
  ul.innerHTML='';
  if(cart.length===0){
    ul.innerHTML='<li style="color:#6b7280">السلة فارغة</li>';
    return;
  }
  cart.forEach(i => {
    const li=document.createElement('li');
    li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='6px 0';
    li.innerHTML=`
      <div>${i.name}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button data-id="${i.id}" data-op="minus" class="btn-sec">-</button>
        <div>${i.qty}</div>
        <button data-id="${i.id}" data-op="plus" class="btn-primary">+</button>
        <div style="min-width:100px;text-align:right">${(Number(i.price*i.qty)).toLocaleString()} ل.س</div>
        <button data-id="${i.id}" data-op="remove" class="btn-sec">حذف</button>
      </div>`;
    ul.appendChild(li);
  });
}

document.getElementById('cartBtn').onclick=()=>{
  const panel=document.getElementById('cartPanel');
  if(panel.style.display==='none' || panel.style.display==='') {
    panel.style.display='block';
  } else {
    panel.style.display='none';
  }
};

document.getElementById('clearCart').onclick=()=>{
  if(confirm('هل تريد تفريغ السلة؟')){
    cart=[];
    saveCart();
    renderCart();
  }
};

document.getElementById('startOrder').onclick=()=>{
  // جمع البيانات
  const userName = document.getElementById('userName').value.trim();
  const userAddress = document.getElementById('userAddress').value.trim();
  const userPhone = document.getElementById('userPhone').value.trim();

  if(!userName || !userAddress || !userPhone){
    alert('يرجى ملء جميع البيانات');
    return;
  }

  const orderData = {
    date: new Date().toISOString(),
    products: cart,
    user: { name: userName, address: userAddress, phone: userPhone }
  };

  // إرسال البيانات إلى Firebase
  firebase.database().ref('orders').push(orderData).then(() => {
    alert('تم إرسال الطلب بنجاح!');
    // تفريغ السلة بعد الإرسال
    cart = [];
    saveCart();
    renderCart();
    // العودة للصفحة السابقة
    window.history.back(); // أو window.location.href='index.html';
  }).catch((error) => {
    alert('حدث خطأ أثناء الإرسال: ' + error.message);
  });
};

document.getElementById('openUserForm').onclick=()=>{
  document.getElementById('userFormContainer').style.display='block';
};

document.getElementById('userForm').onsubmit=function(e){
  e.preventDefault();
  alert('تم حفظ معلومات المستخدم. شكراً!');
  document.getElementById('userFormContainer').style.display='none';
};

// تحميل المنتجات عند البداية
loadProducts();
if(localStorage.getItem('cart')){
  cart=JSON.parse(localStorage.getItem('cart'));
  renderCart();
}
</script>
</body>
</html>
