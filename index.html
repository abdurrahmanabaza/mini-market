<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>السوق الإلكتروني</title>
<!-- إضافة خط من Google Fonts يدعم العربية -->
<link href="https://fonts.googleapis.com/css2?family=Cairo&display=swap" rel="stylesheet" />
<link rel="icon" href="images/icon.jpg">
<!-- أن تضع هنا كود الـ module بعد تحميل الصفحة -->
</head>
<body>
<header>
    <h1>السوق الإلكتروني</h1>
</header>

<!-- زر السلة عائم -->
<button id="cartFloatingButton" onclick="showCartPage()">
    🛒 السلة <span id="cartCount">0</span>
</button>

<!-- المحتوى الرئيسي -->
<div id="mainContent" class="container">
    <h2 style="text-align:center; margin-bottom: 14px; margin-top: 8px;">منتجاتنا</h2>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="🔍 ابحث عن منتج..." />
    </div>
    <div class="products" id="productsContainer"></div>
</div>

<!-- صفحة السلة -->
<div id="cartPage" style="display:none;">
    <h2 style="text-align:center;">السلة</h2>
    <ul id="cartItems"></ul>
    <div id="totalPrice">المجموع النهائي: 0 ل.س</div>
    <button onclick="showMain()" style="margin-top:15px; padding:10px 20px; background-color:#007bff; color:#fff; border:none; border-radius:4px;">العودة للمنتجات</button>
    <button id="confirmOrderBtn" style="margin-top:15px; padding:10px 20px; background-color:#28a745; color:#fff; border:none; border-radius:4px;">تأكيد الطلب</button>
</div>

<!-- حقل التوصيل -->
<div id="orderForm" style="display:none; margin-top:20px;">
    <h3>املأ بيانات التوصيل</h3>
    <label>العنوان:</label>
    <input type="text" id="deliveryAddress" placeholder="أدخل عنوانك" />
    <br/><br/>
    <label>رقم الهاتف:</label>
    <input type="text" id="phoneNumber" placeholder="أدخل رقم هاتفك" />
</div>

<!-- حقوق النشر -->
<footer>
    <p>© 2025 السوق الإلكتروني. جميع الحقوق محفوظة.</p>
</footer>

<!-- سكربتات Firebase باستخدام ES modules -->
<script type="module">
  // استيراد الدوال من Firebase
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

  // إعدادات Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyDqUZQR3O5Ux3nyWsbgdnlQxcAU7qKXrKU",
    authDomain: "local-products-82f7d.firebaseapp.com",
    databaseURL: "https://local-products-82f7d-default-rtdb.firebaseio.com",
    projectId: "local-products-82f7d",
    storageBucket: "local-products-82f7d.firebasestorage.app",
    messagingSenderId: "92892216531",
    appId: "1:92892216531:web:b39013834c0215eaf2e826"
  };

  // تهيئة Firebase
  const app = initializeApp(firebaseConfig);
  const database = getDatabase(app);

  // المنتجات الأساسية مع معرفاتها في Firebase
  const items = [
    { id: '1', name: "جبنة شركسية", image: "images/suger.jpg" },
    { id: '2', name: "جبنة بلدية", image: "images/sult.jpg" },
    { id: '3', name: "لبنة", image: "images/egg.jpg" },
    // أضف باقي المنتجات هنا مع معرفاتها في Firebase
  ];

  let cart = [];
  let filteredItems = [...items];

  // تحميل البيانات من Firebase وتحديث المنتجات
  async function loadData() {
    try {
      const snapshot = await get(ref(database, 'products'));
      if (snapshot.exists()) {
        const data = snapshot.val();
        // تحديث المنتجات بالمعلومات من Firebase
        items.forEach(item => {
          const match = data[item.id];
          if (match) {
            item.name = match.name;
            item.image = match.image;
            item.value = match.value;
            item.quantity = match.quantity;
          }
        });
        renderProducts();
      } else {
        console.log("لا توجد بيانات");
        renderProducts(); // عرض المنتجات الأصلية إذا لم توجد بيانات
      }
    } catch (error) {
      console.error("فشل تحميل البيانات: ", error);
    }
  }

  // عرض المنتجات
  function renderProducts() {
    const container = document.getElementById('productsContainer');
    container.innerHTML = '';
    filteredItems.forEach((item, index) => {
      const realIndex = items.indexOf(item);
      const div = document.createElement('div');
      div.className='product';
      div.innerHTML = `
        <img src="${item.image}" alt="${item.name}" style="width:auto; height:98px; border-radius:8px; margin-bottom:15px; margin: 0 auto; display: block;">
        <h3>${item.name}</h3>
        <p class="price">السعر: ${item.value?.toLocaleString() ?? 'غير متوفر'} ل.س</p>
        <div class="quantity-controls">
            <button onclick="decreaseQty(${realIndex})">-</button>
            <input type="text" id="qtyInput${realIndex}" value="1" readonly />
            <button onclick="increaseQty(${realIndex}, ${item.quantity ?? 0})">+</button>
        </div>
        <a href="#" class="btn" onclick="addToCart(event, ${realIndex})">إضافة إلى السلة</a>
      `;
      container.appendChild(div);
    });
  }

  // البحث
  document.getElementById('searchInput').addEventListener('input', () => {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    if (q === "") {
      filteredItems = [...items];
    } else {
      filteredItems = items.filter(i => i.name.toLowerCase().includes(q));
    }
    renderProducts();
  });

  // زيادة الكمية
  window.increaseQty = function(index, max) {
    const input = document.getElementById(`qtyInput${index}`);
    let val = parseInt(input.value);
    if (val < max) {
      input.value = val + 1;
    } else {
      alert('لا يمكن شراء أكثر من الكمية المتوفرة');
    }
  }

  // تقليل الكمية
  window.decreaseQty = function(index) {
    const input = document.getElementById(`qtyInput${index}`);
    let val = parseInt(input.value);
    if (val > 1) {
      input.value = val - 1;
    }
  }

  // إضافة المنتج إلى السلة
  window.addToCart = function(e, index) {
    e.preventDefault();
    const qty = parseInt(document.getElementById(`qtyInput${index}`).value);
    const item = items[index];
    const existingIndex = cart.findIndex(c => c.index === index);
    if (existingIndex !== -1) {
      if (cart[existingIndex].quantity + qty <= item.quantity) {
        cart[existingIndex].quantity += qty;
      } else {
        alert('الكمية الإجمالية تتجاوز الكمية المتوفرة');
        return;
      }
    } else {
      cart.push({ index, name: item.name, value: item.value, quantity: qty, max: item.quantity });
    }
    updateCartCount();
    alert('تمت إضافة المنتج إلى السلة');
  }

  // تحديث عداد السلة
  function updateCartCount() {
    const totalItems = cart.reduce((sum, c) => sum + c.quantity, 0);
    document.getElementById('cartCount').innerText = totalItems;
  }

  // عرض صفحة السلة
 window.showCartPage = function() {
    document.getElementById('mainContent').style.display='none';
    document.getElementById('cartPage').style.display='block';
    renderCart();
    document.getElementById('orderForm').classList.remove('active');
 }

 // العودة للصفحة الرئيسية
 window.showMain = function() {
    document.getElementById('mainContent').style.display='block';
    document.getElementById('cartPage').style.display='none';
    document.getElementById('orderForm').classList.remove('active');
 }

 // عرض محتوى السلة
 function renderCart() {
    const container = document.getElementById('cartItems');
    container.innerHTML = '';
    let total = 0;
    cart.forEach((item, index) => {
      total += item.value * item.quantity;
      const li = document.createElement('li');
      li.innerHTML = `
        <strong>${item.name}</strong><br/>
        السعر: ${item.value.toLocaleString()} ل.س<br/>
        الكمية: ${item.quantity} <br/>
        <button onclick="removeFromCart(${index})" style="margin-top:5px; padding:5px 10px; background-color:#e60000; color:#fff; border:none; border-radius:4px; cursor:pointer;">حذف</button>
      `;
      container.appendChild(li);
    });
    document.getElementById('totalPrice').innerText = `المجموع النهائي: ${total.toLocaleString()} ل.س`;
 }

 function removeFromCart(i) {
    cart.splice(i,1);
    renderCart();
    updateCartCount();
 }

 // تأكيد الطلب
 document.getElementById('confirmOrderBtn').addEventListener('click', () => {
    if (cart.length === 0) {
      alert('السلة فارغة');
      return;
    }
    document.getElementById('orderForm').classList.add('active');
    document.getElementById('cartPage').style.display='none';
 });

 // إرسال الطلب عبر واتساب
 document.querySelector('#confirmOrderBtn').addEventListener('click', () => {
    const address = document.getElementById('deliveryAddress').value.trim();
    const phone = document.getElementById('phoneNumber').value.trim();
    if (!address || !phone) {
      alert('يرجى ملء العنوان ورقم الهاتف');
      return;
    }
    let message = 'طلب جديد:\n';
    let total = 0;
    cart.forEach(item => {
      total += item.value * item.quantity;
      message += `${item.name} × ${item.quantity}\n`;
    });
    message += `ـــــــــــــــــــــــــــــــــــــ\n`;
    message += `المجموع النهائي: ${total.toLocaleString()} ل.س\n`;
    message += `\nالعنوان: ${address}\n`;
    message += `رقم الهاتف: ${phone}\n`;
    const encodedMessage = encodeURIComponent(message);
    const whatsappNumber = '+963936421060';
    const whatsappURL = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
    window.open(whatsappURL, '_blank');
    document.getElementById('deliveryAddress').value = '';
    document.getElementById('phoneNumber').value = '';
    document.getElementById('orderForm').classList.remove('active');
    showMain();
 });

 // وظيفة وضع المدير تظهر عند النزول لأسفل
 const adminBtn = document.getElementById('adminFixedBtn');
 window.addEventListener('scroll', () => {
    if (window.scrollY > 300) {
      adminBtn.style.display = 'block';
    } else {
      adminBtn.style.display = 'none';
    }
 });

 function promptAdmin() {
    const pw = prompt('أدخل كلمة سر المدير:');
    if (pw === 'admin123') {
      document.getElementById('adminPanel').style.display='block';
      renderAdminProducts();
    } else {
      alert('كلمة السر غير صحيحة');
    }
 }

 function renderAdminProducts() {
    const container = document.getElementById('adminProducts');
    container.innerHTML = '';
    items.forEach((item, i) => {
      container.innerHTML += `
      <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:5px;">
        <input style="width:100%; margin-bottom:5px;" placeholder="اسم المنتج" onchange="items[${i}].name=this.value" value="${item.name}"/>
        <input style="width:100%; margin-bottom:5px;" type="number" placeholder="السعر" onchange="items[${i}].value=Number(this.value)" value="${item.value}"/>
        <input style="width:100%; margin-bottom:5px;" type="number" placeholder="الكمية" onchange="items[${i}].quantity=Number(this.value)" value="${item.quantity}"/>
        <button onclick="deleteItem(${i})" style="background:#e60000; color:#fff; border:none; padding:5px 8px; border-radius:4px; cursor:pointer;">حذف</button>
      </div>
      `;
    });
 }

 function addProduct() {
    items.push({name:'مادة جديدة', value:1000, quantity:100});
    renderAdminProducts();
    renderProducts();
 }

 function deleteItem(i) {
    items.splice(i,1);
    renderAdminProducts();
    renderProducts();
 }

 function closeAdmin() {
    document.getElementById('adminPanel').style.display='none';
 }

 // تحميل البيانات عند بداية الصفحة
 loadData();

</script>
</body>
</html>
