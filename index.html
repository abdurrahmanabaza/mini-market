<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø³ÙˆÙ‚ Ø¨Ø¦Ø±Ø¹Ø¬Ù… Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; direction: rtl; background:#f5f7fb; padding:18px; color:#0b1726; }
  .wrap { max-width:980px; margin:auto; }
  header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
  input[type="search"] { padding:8px; border-radius:8px; border:1px solid #d7dbe6; width:260px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }
  .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:700; }
  .meta { display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#6b7280; }
  .actions { display:flex; gap:8px; margin-top:8px; }
  button { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; }
  .btn-primary { background:#0f62fe; color:#fff; }
  .btn-sec { background:#eef2ff; color:#0f62fe; }
  #cartBtn {
    background:#06b6d4; color:#fff; border-radius:8px; padding:8px 10px; position:fixed; top:20px; right:20px; z-index:9999; cursor:pointer; box-shadow:0 4px 8px rgba(0,0,0,0.2); transition:background 0.3s;
  }
  #cartBtn:hover { background:#0590d4; }
  #log { margin-top:12px; color:#b91c1c; }
  /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØµÙˆØ± */
  .product-image { width:100%; height:auto; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:transform 0.3s, box-shadow 0.3s; }
  .product-image:hover { transform:scale(1.02); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
  @media(max-width:768px){
    .grid { grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); }
    input[type="search"] { width: 100%; }
    header { flex-direction: column; align-items: flex-start; }
  }
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1 style="margin:0">Ø³ÙˆÙ‚ Ø¨Ø¦Ø±Ø¹Ø¬Ù… Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª</h1>
    <div style="color:#6b7280;font-size:13px">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div id="count" style="background:#eef2ff;padding:6px 8px;border-radius:8px">--</div>
    <input id="search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
  </div>
</header>

<main>
<section id="products" class="grid">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</section>

<section id="cartPanel" style="display:none;margin-top:14px">
  <h3>Ø§Ù„Ø³Ù„Ø©</h3>
  <ul id="cartList" style="padding:0;margin:0;list-style:none"></ul>
  <div style="margin-top:10px;font-weight:700">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cartTotal">0</span> Ù„.Ø³</div>
  <div style="margin-top:8px">
    <button id="clearCart" class="btn-sec">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
    <button id="startOrder" class="btn-primary">Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  </div>
</section>

<!-- Ø²Ø± Ø§Ù„Ø³Ù„Ø© Ø¹Ø§Ø¦Ù… -->
<button id="floatingCart" style="display:none;">Ø§Ù„Ø³Ù„Ø© (0)</button>

<!-- ØµÙØ­Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù†ÙØµÙ„Ø© -->
<div id="userFormContainer" style="display:none; margin-top:20px;">
  <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3>
  <form id="userForm">
    <input type="text" id="userName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" required />
    <input type="text" id="userAddress" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" required />
    <input type="tel" id="userPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required />
    <button type="submit" class="btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
  </form>
</div>

<div id="log"></div>
</main>
</div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqUZQR3O5Ux3nyWsbgdnlQxcAU7qKXrKU",
  authDomain: "local-products-82f7d.firebaseapp.com",
  databaseURL: "https://local-products-82f7d-default-rtdb.firebaseio.com",
  projectId: "local-products-82f7d",
  storageBucket: "local-products-82f7d.appspot.com",
  messagingSenderId: "92892216531",
  appId: "1:92892216531:web:b39013834c0215eaf2e826"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ø¹Ù†Ø§ØµØ± DOM
const productsEl = document.getElementById('products');
const countEl = document.getElementById('count');
const searchEl = document.getElementById('search');
const cartPanel = document.getElementById('cartPanel');
const cartList = document.getElementById('cartList');
const cartTotal = document.getElementById('cartTotal');
const clearCart = document.getElementById('clearCart');
const startOrderBtn = document.getElementById('startOrder');
const logEl = document.getElementById('log');
const floatingCart = document.getElementById('floatingCart');

let products = [];
let filtered = [];
let cart = [];

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function loadProducts() {
  productsEl.innerHTML='Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
  db.ref('products').once('value')
  .then(snap => {
    const data = snap.val();
    if(!data){
      productsEl.innerHTML='<div style="color:#6b7280">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>';
      countEl.innerText='0';
      return;
    }
    products=Object.entries(data).map(([k,v]) => ({
      id: Number(k),
      name: v.name || '',
      quantity: Number(v.quantity || 0),
      price: Number(v.price !== undefined ? v.price : (v.value!==undefined?v.value:0)),
      imageUrl: v.imageUrl || ''
    }));
    filtered=products.slice();
    renderProducts();
  })
  .catch(e => {
    productsEl.innerHTML='<div style="color:#b91c1c">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>';
    logEl.innerText='ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£: '+(e.message||e);
  });
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function renderProducts() {
  productsEl.innerHTML='';
  if(!filtered.length){
    productsEl.innerHTML='<div style="color:#6b7280">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
    countEl.innerText='0';
    return;
  }
  countEl.innerText=String(filtered.length);
  filtered.forEach(p => {
    const nameSafe=escapeHtml(p.name);
    const priceStr=Number(p.price).toLocaleString();
    const qtyStr=String(Number(p.quantity));
    const imgSrc=p.imageUrl ? p.imageUrl:'https://via.placeholder.com/240x180?text=Ù„Ø§+ØµÙˆØ±';
    const imgStyle='width:100%; height:auto; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:transform 0.3s, box-shadow 0.3s;';
    const imgHover='transform:scale(1.02); box-shadow:0 8px 16px rgba(0,0,0,0.2);';
    const cardHTML=`
      <div class="card">
        <img src="${imgSrc}" style="${imgStyle}" onmouseover="this.style.cssText='${imgStyle}${imgHover}'" onmouseout="this.style.cssText='${imgStyle}'" />
        <div class="title">${nameSafe}</div>
        <div class="meta">
          <div>Ø§Ù„Ø³Ø¹Ø±: <strong>${priceStr}</strong> Ù„.Ø³</div>
          <div>Ø§Ù„ÙƒÙ…ÙŠØ©: <span>${qtyStr}</span></div>
        </div>
        <div class="actions">
          <button class="btn-sec" data-action="details" data-id="${p.id}">ØªÙØ§ØµÙŠÙ„</button>
          <button class="btn-primary" data-action="add" data-id="${p.id}">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>`;
    const div=document.createElement('div');
    div.innerHTML=cardHTML;
    productsEl.appendChild(div);
  });
}

function escapeHtml(text){ return String(text||'').replace(/[&<>"'`=\/]/g,s=>'&#'+s.charCodeAt(0)+';'); }

// Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
productsEl.addEventListener('click', e => {
  const btn=e.target.closest('button');
  if(!btn) return;
  const action=btn.getAttribute('data-action');
  const id=btn.getAttribute('data-id');
  if(action==='add') addToCart(id);
  if(action==='details') showDetails(id);
});

function addToCart(id){
  id=Number(id);
  const p=products.find(x=>x.id===id);
  if(!p){ alert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  if(p.quantity<=0){ alert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©'); return; }
  const existing=cart.find(c=>c.id===id);
  if(existing){
    if(existing.qty+1>p.quantity){ alert('ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©'); return; }
    existing.qty++;
  }else{
    cart.push({id:p.id, name:p.name, price:p.price, qty:1, max:p.quantity});
  }
  updateCartUI();

  // Ø­Ø±ÙƒØ© ØªÙØ§Ø¹Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
  const btns=document.querySelectorAll('button[data-action="add"]');
  btns.forEach(btn => {
    if(btn.getAttribute('data-id')===id.toString()){
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ù…Ø¤Ù‚Øª
      const bubble=document.createElement('div');
      bubble.innerHTML='ğŸ›’'; // ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙŠ Ø±Ù…Ø²
      bubble.style.position='fixed';
      const rect=btn.getBoundingClientRect();
      bubble.style.left=rect.left+'px';
      bubble.style.top=rect.top+'px';
      bubble.style.fontSize='24px';
      bubble.style.opacity='1';
      bubble.style.transition='all 1s ease-out';
      bubble.style.zIndex='9999';
      document.body.appendChild(bubble);

      // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø¹Ù†ØµØ±
      setTimeout(()=> {
        bubble.style.transform='translateY(-100px)';
        bubble.style.opacity='0';
      }, 10);

      // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
      setTimeout(()=> {
        if(bubble.parentNode) bubble.parentNode.removeChild(bubble);
      }, 1000);
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
  updateFloatingCart();
}

function showDetails(id){
  const p=products.find(x=>x.id===id);
  if(!p) return alert('ØªÙØ§ØµÙŠÙ„ ØºÙŠØ± Ù…ØªØ§Ø­Ø©');
  alert(p.name+'\nØ§Ù„Ø³Ø¹Ø±: '+Number(p.price).toLocaleString()+' Ù„.Ø³\nØ§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: '+Number(p.quantity));
}

function updateCartUI() {
  const totalItems=cart.reduce((s,i)=>s+i.qty,0);
  document.getElementById('cartBtn')?.innerText='Ø§Ù„Ø³Ù„Ø© ('+totalItems+')'; // Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
  renderCart();
  // Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø© ÙÙŠ LocalStorage
  localStorage.setItem('cart', JSON.stringify(cart));
}

function renderCart() {
  const ul=document.getElementById('cartList');
  ul.innerHTML='';
  if(!cart.length){
    ul.innerHTML='<li style="color:#6b7280">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</li>';
    document.getElementById('cartTotal').innerText='0';
    updateFloatingCart(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø§Ø¦Ù…
    return;
  }
  let total=0;
  cart.forEach(i => {
    total+=i.price*i.qty;
    const li=document.createElement('li');
    li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='6px 0';
    li.innerHTML=`
      <div>${escapeHtml(i.name)}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button data-id="${i.id}" data-op="minus" class="btn-sec">-</button>
        <div>${i.qty}</div>
        <button data-id="${i.id}" data-op="plus" class="btn-primary">+</button>
        <div style="min-width:100px;text-align:right">${(Number(i.price*i.qty)).toLocaleString()} Ù„.Ø³</div>
        <button data-id="${i.id}" data-op="remove" class="btn-sec">Ø­Ø°Ù</button>
      </div>`;
    ul.appendChild(li);
  });
  document.getElementById('cartTotal').innerText=total.toLocaleString();
  updateFloatingCart();
}

// ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¹Ø§Ø¦Ù…
function updateFloatingCart() {
  const totalItems=cart.reduce((s,i)=>s+i.qty,0);
  floatingCart.innerText='Ø§Ù„Ø³Ù„Ø© ('+totalItems+')';
  floatingCart.style.display=totalItems>0?'block':'none';
}

// Ø£Ø­Ø¯Ø§Ø« Ø²Ø± Ø§Ù„Ø³Ù„Ø© Ø§Ù„Ø¹Ø§Ø¦Ù…
document.getElementById('floatingCart').addEventListener('click', () => {
  cartPanel.style.display='block';
  renderCart();
  cartPanel.scrollIntoView({behavior:'smooth'});
});

// Ø£Ø­Ø¯Ø§Ø« Ø³Ù„Ø© Ø§Ù„ØªØ³ÙˆÙ‚
document.getElementById('cartList').addEventListener('click', e => {
  const btn=e.target.closest('button');
  if(!btn) return;
  const id=btn.getAttribute('data-id');
  const op=btn.getAttribute('data-op');
  if(op==='plus') changeQty(id,1);
  if(op==='minus') changeQty(id,-1);
  if(op==='remove') removeFromCart(id);
});

function changeQty(id,delta){
  id=Number(id);
  const it=cart.find(c=>c.id===id);
  if(!it) return;
  const p=products.find(p=>p.id===id);
  const newQty=it.qty+delta;
  if(newQty<=0) return;
  if(newQty>p.quantity){ alert('ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©'); return; }
  it.qty=newQty;
  updateCartUI();
}

function removeFromCart(id){
  id=Number(id);
  cart=cart.filter(c=>c.id!==id);
  updateCartUI();
}

// ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©
document.getElementById('clearCart').addEventListener('click', () => {
  if(!cart.length) return;
  if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©ØŸ')) { cart=[]; updateCartUI(); }
});

// Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨" ÙŠÙØªØ­ ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
document.getElementById('startOrder').addEventListener('click', () => {
  window.location.href='checkout.html'; // ØªÙˆØ¬Ù‡ Ù„ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
});

// Ø§Ù„Ø¨Ø­Ø«
searchEl.addEventListener('input', ()=> {
  const q=searchEl.value.trim().toLowerCase();
  filtered=products.filter(p=>p.name.toLowerCase().includes(q));
  renderProducts();
});

loadProducts();
</script>
</body>
</html>
