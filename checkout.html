<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>سوق بئرعجم للمنتجات</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; direction: rtl; background:#f5f7fb; padding:18px; color:#0b1726; }
  .wrap { max-width:980px; margin:auto; }
  header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px; }
  input[type="search"] { padding:8px; border-radius:8px; border:1px solid #d7dbe6; width:260px; }
  .grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr)); gap:12px; }
  .card { background:#fff; padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.06); display:flex; flex-direction:column; gap:8px; }
  .title { font-weight:700; }
  .meta { display:flex; justify-content:space-between; align-items:center; font-size:13px; color:#6b7280; }
  .actions { display:flex; gap:8px; margin-top:8px; }
  button { padding:8px 10px; border-radius:8px; border:0; cursor:pointer; }
  .btn-primary { background:#0f62fe; color:#fff; }
  .btn-sec { background:#eef2ff; color:#0f62fe; }
  #cartBtn { background:#06b6d4; color:#fff; border-radius:8px; padding:8px 10px; }
  #log { margin-top:12px; color:#b91c1c; }
  
  /* تأثيرات الصور */
  .product-image { width:80px; height:auto; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); transition:transform 0.3s, box-shadow 0.3s; }
  .product-image:hover { transform:scale(1.02); box-shadow:0 8px 16px rgba(0,0,0,0.2); }
  
  /* قسم المادة الخاصة */
  #specialPriceSection { margin-top:20px; display:none; border:1px solid #ccc; padding:15px; border-radius:8px; background:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
  #specialPriceSection h3 { margin-top:0; color:#0f62fe; }
  #specialPriceSelect { padding:8px; border-radius:6px; border:1px solid #d7dbe6; width:100%; margin-bottom:10px; }
  #specialPriceSection p { margin:8px 0; }
  
  /* قسم عرض معلومات المادة الخاصة */
  #specialInfoDisplay { display:none; position:fixed; top:20px; right:20px; background:#fff; padding:15px; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.2); z-index:999; border:2px solid #0f62fe; max-width:300px; }
  #specialInfoDisplay h4 { margin-top:0; color:#0f62fe; }
  #specialInfoDisplay div { margin-bottom:8px; }
  
  /* زر إضافة المادة الخاصة */
  .special-btn { background:#ff9800; color:#fff; }
  .special-btn:disabled { background:#ccc; cursor:not-allowed; }
  
  /* رسالة تأكيد */
  .confirmation-message { background:#e8f5e9; border:1px solid #4caf50; color:#2e7d32; padding:10px; border-radius:6px; margin-top:10px; display:none; }
  
  @media(max-width:768px){
    .grid { grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); }
    input[type="search"] { width: 100%; }
    header { flex-direction: column; align-items: flex-start; }
    #cartPanel { font-size:16px; }
    #specialInfoDisplay { position:relative; top:auto; right:auto; max-width:100%; margin-bottom:15px; }
  }
</style>
</head>
<body>
<div class="wrap">
<header>
  <div>
    <h1 style="margin:0">سوق بئرعجم للمنتجات</h1>
    <div style="color:#6b7280;font-size:13px">مرحباً بك</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px">
    <div id="count" style="background:#eef2ff;padding:6px 8px;border-radius:8px">--</div>
    <input id="search" type="search" placeholder="ابحث باسم المنتج..." />
    <button id="cartBtn">السلة (0)</button>
  </div>
</header>

<!-- قسم المادة الخاصة مخفي افتراضياً -->
<div id="specialPriceSection">
  <h3>اختر السعر للمادة الخاصة</h3>
  <select id="specialPriceSelect"></select>
  <p>السعر المحدد: <span id="selectedPriceDisplay"></span> ل.س</p>
  <button id="confirmSpecialItem" class="special-btn">إضافة المادة الخاصة للسلة</button>
  <div id="specialConfirmation" class="confirmation-message"></div>
</div>

<!-- قسم عرض معلومات المادة الخاصة مخفي -->
<div id="specialInfoDisplay">
  <h4>معلومات المادة الخاصة</h4>
  <div>الوزن: <span id="specialWeight"></span></div>
  <div>السعر: <span id="specialPriceDisplay"></span> ل.س</div>
</div>

<main>
<section id="products" class="grid">جارٍ التحميل...</section>

<section id="cartPanel" style="display:none;margin-top:14px">
  <h3>السلة</h3>
  <ul id="cartList" style="padding:0;margin:0;list-style:none"></ul>
  <div style="margin-top:10px;font-weight:700">الإجمالي: <span id="cartTotal">0</span> ل.س</div>
  <div style="margin-top:8px">
    <button id="clearCart" class="btn-sec">تفريغ السلة</button>
    <button id="startOrder" class="btn-primary">أكمل الطلب</button>
  </div>
</section>

<!-- زر لفتح صفحة إدخال البيانات -->
<div style="margin-top:20px;text-align:center;">
  <button id="openUserForm" class="btn-primary">إدخال معلومات المستخدم</button>
</div>
<!-- صفحة معلومات المستخدم منفصلة -->
<div id="userFormContainer" style="display:none; margin-top:20px;">
  <h3>معلومات المستخدم</h3>
  <form id="userForm">
    <input type="text" id="userName" placeholder="الاسم الكامل" required />
    <input type="text" id="userAddress" placeholder="العنوان" required />
    <input type="tel" id="userPhone" placeholder="رقم الهاتف" required />
    <button type="submit" class="btn-primary">حفظ البيانات</button>
  </form>
</div>

<div id="log"></div>
</main>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDqUZQR3O5Ux3nyWsbgdnlQxcAU7qKXrKU",
  authDomain: "local-products-82f7d.firebaseapp.com",
  databaseURL: "https://local-products-82f7d-default-rtdb.firebaseio.com",
  projectId: "local-products-82f7d",
  storageBucket: "local-products-82f7d.appspot.com",
  messagingSenderId: "92892216531",
  appId: "1:92892216531:web:b39013834c0215eaf2e826"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const productsEl = document.getElementById('products');
const countEl = document.getElementById('count');
const searchEl = document.getElementById('search');
const cartBtn = document.getElementById('cartBtn');
const cartPanel = document.getElementById('cartPanel');
const cartList = document.getElementById('cartList');
const cartTotal = document.getElementById('cartTotal');
const specialPriceSection = document.getElementById('specialPriceSection');
const specialInfoDisplay = document.getElementById('specialInfoDisplay');
const confirmSpecialItemBtn = document.getElementById('confirmSpecialItem');

let products = [];
let filtered = [];
let cart = [];
let specialPrices = [];
let specialItemAdded = false;

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function loadSpecialPrices() {
  db.ref('products/0/prices').once('value')
    .then(snap => {
      const data = snap.val();
      if (data) {
        specialPrices = Object.entries(data).map(([k,v]) => ({
          weight: v.weight || '',
          price: Number(v.price || 0)
        }));
        if (specialPrices.length > 0) {
          populateSpecialPriceOptions();
        }
      }
    });
}

function populateSpecialPriceOptions() {
  const select = document.getElementById('specialPriceSelect');
  select.innerHTML='';
  specialPrices.forEach((item, index) => {
    const option=document.createElement('option');
    option.value=index;
    option.text=`وزن: ${item.weight} - السعر: ${item.price.toLocaleString()} ل.س`;
    select.appendChild(option);
  });
  
  // إظهار قسم المادة الخاصة فقط إذا لم يتم إضافتها للسلة
  if (!specialItemAdded) {
    specialPriceSection.style.display='block';
  }
  
  select.onchange=()=>{
    const selected=specialPrices[select.value];
    document.getElementById('selectedPriceDisplay').innerText=selected.price.toLocaleString();
  };
  select.value=0;
  document.getElementById('selectedPriceDisplay').innerText=specialPrices[0].price.toLocaleString();
}

function loadProducts() {
  productsEl.innerHTML='جارٍ التحميل...';
  db.ref('products').once('value')
  .then(snap => {
    const data=snap.val();
    if(!data){
      productsEl.innerHTML='<div style="color:#6b7280">لا توجد منتجات</div>';
      countEl.innerText='0';
      return;
    }
    products=Object.entries(data).map(([k,v])=>({
      id:Number(k),
      name:v.name||'',
      quantity:Number(v.quantity||0),
      price:Number(v.price!==undefined?v.price:(v.value!==undefined?v.value:0)),
      imageUrl:v.imageUrl||''
    }));
    filtered=products.slice();
    renderProducts();
  });
}

function renderProducts() {
  productsEl.innerHTML='';
  if(!filtered.length){
    productsEl.innerHTML='<div style="color:#6b7280">لا توجد منتجات تطابق بحثك</div>';
    countEl.innerText='0';
    return;
  }
  countEl.innerText=filtered.length;
  
  filtered.forEach(p => {
    const card=document.createElement('div');
    card.className='card';
    
    // التحقق مما إذا كانت المادة الخاصة موجودة في السلة
    const isSpecialAdded = cart.some(item => item.id === 0);
    
    card.innerHTML=`
      <div class="title">${escapeHtml(p.name)}</div>
      ${p.imageUrl?`<img src="${p.imageUrl}" class="product-image" alt="${p.name}">`:''}
      <div class="meta">
        <div>${Number(p.price).toLocaleString()} ل.س</div>
        <div>المتاح: ${Number(p.quantity)}</div>
      </div>
      <div class="actions">
        <button class="btn-sec" onclick="showDetails(${p.id})">تفاصيل</button>
        ${p.id === 0 ? 
          `<button class="special-btn" onclick="addSpecialItem()" ${isSpecialAdded ? 'disabled' : ''}>
            ${isSpecialAdded ? 'مضافة للسلة' : 'إضافة للسلة'}
          </button>` : 
          `<button class="btn-primary" onclick="addToCart(${p.id})">إضافة للسلة</button>`
        }
      </div>`;
    productsEl.appendChild(card);
  });
}

function showDetails(id){
  id=Number(id);
  const p=products.find(x=>x.id===id);
  if(!p) return alert('تفاصيل غير متاحة');
  alert(p.name+'\nالسعر: '+Number(p.price).toLocaleString()+' ل.س\nالكمية المتاحة: '+Number(p.quantity));
}

function addToCart(id){
  id=Number(id);
  const p=products.find(x=>x.id===id);
  if(!p) return;
  if(p.quantity<=0) return alert('الكمية غير متاحة');
  
  const existing=cart.find(x=>x.id===id);
  if(existing){
    if(existing.qty>=p.quantity) return alert('لا يمكن إضافة المزيد، الكمية المتاحة: '+p.quantity);
    existing.qty++;
  }else{
    cart.push({id:p.id, name:p.name, price:p.price, qty:1});
  }
  updateCartUI();
}

function addSpecialItem() {
  const select = document.getElementById('specialPriceSelect');
  const selectedIndex = select.value;
  const selectedItem = specialPrices[selectedIndex];
  
  // عرض رسالة تأكيد
  const confirmation = document.getElementById('specialConfirmation');
  confirmation.innerHTML = `هل تريد إضافة المادة الخاصة (${selectedItem.weight}) بسعر ${selectedItem.price.toLocaleString()} ل.س؟`;
  confirmation.style.display = 'block';
  
  // إضافة المادة للسلة بعد التأكيد
  confirmSpecialItemBtn.onclick = function() {
    // إضافة المادة الخاصة للسلة
    cart.push({
      id: 0, 
      name: `مادة خاصة (${selectedItem.weight})`, 
      price: selectedItem.price, 
      qty: 1
    });
    
    // تحديث واجهة المستخدم
    updateCartUI();
    
    // إخفاء قسم المادة الخاصة
    specialPriceSection.style.display = 'none';
    
    // إخفاء رسالة التأكيد
    confirmation.style.display = 'none';
    
    // عرض معلومات المادة الخاصة مؤقتاً
    showSpecialItemInfo(selectedItem);
    
    // تعيين علامة أن المادة الخاصة قد أضيفت
    specialItemAdded = true;
  };
}

function showSpecialItemInfo(item) {
  document.getElementById('specialWeight').innerText = item.weight;
  document.getElementById('specialPriceDisplay').innerText = item.price.toLocaleString();
  specialInfoDisplay.style.display = 'block';
  
  // إخفاء المعلومات بعد 3 ثوانٍ
  setTimeout(() => {
    specialInfoDisplay.style.display = 'none';
  }, 3000);
}

function updateCartUI() {
  const totalItems=cart.reduce((s,i)=>s+i.qty,0);
  document.getElementById('cartBtn').innerText='السلة ('+totalItems+')';
  renderCart();
  renderProducts(); // إعادة عرض المنتجات لتحديث حالة أزرار المادة الخاصة
  localStorage.setItem('cart', JSON.stringify(cart));
  
  // التحقق من وجود المادة الخاصة في السلة
  specialItemAdded = cart.some(item => item.id === 0);
  
  // إظهار أو إخفاء قسم المادة الخاصة بناءً على الحالة
  if (specialItemAdded) {
    specialPriceSection.style.display = 'none';
  } else {
    specialPriceSection.style.display = 'block';
  }
}

function renderCart() {
  const ul=document.getElementById('cartList');
  ul.innerHTML='';
  if(!cart.length){
    ul.innerHTML='<li style="color:#6b7280">السلة فارغة</li>';
    document.getElementById('cartTotal').innerText='0';
    cartPanel.style.display='none';
    return;
  }
  
  cartPanel.style.display='block';
  let total=0;
  cart.forEach(i => {
    total+=i.price*i.qty;
    const li=document.createElement('li');
    li.style.display='flex'; li.style.justifyContent='space-between'; li.style.alignItems='center'; li.style.padding='6px 0';
    li.innerHTML=`
      <div>${escapeHtml(i.name)}</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button data-id="${i.id}" data-op="minus" class="btn-sec">-</button>
        <div>${i.qty}</div>
        <button data-id="${i.id}" data-op="plus" class="btn-primary">+</button>
        <div style="min-width:100px;text-align:right">${(Number(i.price*i.qty)).toLocaleString()} ل.س</div>
        <button data-id="${i.id}" data-op="remove" class="btn-sec">حذف</button>
      </div>`;
    ul.appendChild(li);
  });
  document.getElementById('cartTotal').innerText=total.toLocaleString();
}

document.getElementById('cartList').addEventListener('click', e => {
  const btn=e.target.closest('button');
  if(!btn) return;
  const id=btn.getAttribute('data-id');
  const op=btn.getAttribute('data-op');
  if(op==='plus') changeQty(id,1);
  if(op==='minus') changeQty(id,-1);
  if(op==='remove') removeFromCart(id);
});

function changeQty(id,delta){
  id=Number(id);
  const it=cart.find(c=>c.id===id);
  if(!it) return;
  const p=products.find(p=>p.id===id);
  const newQty=it.qty+delta;
  if(newQty<=0) return;
  if(newQty>p.quantity){ alert('تجاوزت الكمية المتاحة'); return; }
  it.qty=newQty;
  updateCartUI();
}

function removeFromCart(id){
  id=Number(id);
  cart=cart.filter(c=>c.id!==id);
  
  // إذا كانت المادة الخاصة هي التي تم حذفها
  if (id === 0) {
    specialItemAdded = false;
    specialPriceSection.style.display = 'block';
  }
  
  updateCartUI();
}

document.getElementById('clearCart').addEventListener('click', () => {
  if(!cart.length) return;
  if(confirm('هل تريد تفريغ السلة؟')) { 
    cart=[]; 
    specialItemAdded = false;
    specialPriceSection.style.display = 'block';
    updateCartUI(); 
  }
});

document.getElementById('startOrder').addEventListener('click', () => {
  window.location.href='checkout.html';
});

searchEl.addEventListener('input', ()=> {
  const q=searchEl.value.trim().toLowerCase();
  filtered=products.filter(p=>p.name.toLowerCase().includes(q));
  renderProducts();
});

// عند التمرير، إخفاء المعلومات الخاصة
window.addEventListener('scroll', () => {
  const infoDiv=document.getElementById('specialInfoDisplay');
  if(infoDiv.style.display==='block'){
    infoDiv.style.display='none';
  }
});

// تحميل البيانات
loadProducts();
loadSpecialPrices();

</script>
</body>
</html>
